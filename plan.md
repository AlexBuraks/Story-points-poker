# Implementation Plan v1.2 — 2026-01-30

## Общая стратегия
Устранить лаги при взаимодействии с элементами управления комнатой (Show/Hide, Reset) путем внедрения Optimistic UI. Пользователь должен видеть результат клика немедленно, а серверный запрос и поллинг должны подтверждать это состояние в фоновом режиме.

## Пошаговый чек-лист

### Phase 1: Оптимизация Show/Hide (app/room/[id]/page.tsx)
- [x] **Шаг 1:** В `handleRevealToggle` добавить мгновенное обновление стейта `room`:
  ```typescript
  setRoom(prev => prev ? { ...prev, revealed: !prev.revealed } : null);
  ```
  ✅ **Реализовано:** Добавлен Optimistic UI с механизмом rollback при ошибке (app/room/[id]/page.tsx:189-227)
- [x] **Шаг 2:** Убрать/минимизировать использование `isLoading` для блокировки кнопки. Лучше оставить `isLoading` для предотвращения двойных кликов, но не показывать лоадер, если ответ быстрый.
  ✅ **Реализовано:** `isLoading` оставлен для защиты от спама, UI обновляется мгновенно до запроса

### Phase 2: Оптимизация Reset (app/room/[id]/page.tsx)
- [x] **Шаг 1:** В `handleReset` добавить полную очистку стейта комнаты:
  ```typescript
  setRoom(prev => {
    if (!prev) return null;
    const newParticipants = { ...prev.participants };
    Object.keys(newParticipants).forEach(uid => {
      newParticipants[uid] = { ...newParticipants[uid], vote: null };
    });
    return { ...prev, revealed: false, participants: newParticipants };
  });
  ```
  ✅ **Реализовано:** Добавлен Optimistic UI с полной очисткой участников и rollback при ошибке (app/room/[id]/page.tsx:229-275)
- [x] **Шаг 2:** Убедиться, что это мгновенно скрывает карты у всех участников (на стороне модератора) и очищает его собственный `optimisticVote`.
  ✅ **Реализовано:** Весь стейт (room + optimisticVote + guideResetKey) обновляется мгновенно

### Phase 3: Полировка UI (Optional)
- [ ] **Шаг 1:** В `RoomControls` можно добавить едва заметную анимацию перехода, чтобы глаз не цеплялся за резкую смену текста.

## Критические моменты
- **Конфликт с поллингом:** Если поллинг случится ДО того, как сервер обработает запрос, UI может "прыгнуть" назад и вперед.
  - *Решение:* Можно добавить флаг `isUpdating`, который блокирует обновление из поллинга на 1-2 секунды после нашего действия, либо полагаться на то, что серверный ответ придет быстрее следующего цикла (3 сек).
- **Откат при ошибке:** Если запрос к API упал, нужно вернуть стейт `room` в предыдущее состояние.

## Testing checklist
- [ ] Нажать "Show estimates" -> Текст сменился мгновенно, карты в списке участников открылись (для модератора).
- [ ] Нажать "Hide estimates" -> Текст сменился мгновенно.
- [ ] Нажать "Delete estimates" -> Все голоса в списке исчезли, карты перевернулись мгновенно.
- [ ] Имитировать ошибку сети -> UI должен откатиться к исходному состоянию и показать ошибку.
 village
