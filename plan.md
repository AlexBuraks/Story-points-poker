# Implementation Plan v1.1 — 2026-01-30

## Общая стратегия
Синхронизировать состояние `VotingGuide` и `PokerCard` так, чтобы любое действие в одном компоненте корректно отражалось или сбрасывало состояние в другом, при этом обеспечивая корректную передачу `null` (сброс голоса).

## Пошаговый чек-лист

### Phase 1: Улучшение VotingGuide (components/voting-guide.tsx)
- [x] **Шаг 1:** Обновить `useEffect` для `onVote`: он должен уметь отправлять `null`, если `suggestedSpValue` стал `null` (после того как был не `null`). Это критично для сброса голоса при очистке таблицы.
- [x] **Шаг 2:** Проверить, что переключение `isAiMode` мгновенно вызывает `onVote` с новым значением (т.к. `suggestedSpValue` меняется через `useMemo`).
- [x] **Шаг 3:** Убедиться, что `lastVotedValueRef` корректно сбрасывается при внешнем `resetTrigger`.

### Phase 2: Логика в Room Page (app/room/[id]/page.tsx)
- [x] **Шаг 1:** В `handleVote` добавить обработку `vote === null`. Если голос сбрасывается, это должно очищать UI у пользователя.
- [x] **Шаг 2:** При повторном клике на ту же карту в `page.tsx` вызвать `handleVote(null, true)`. Это позволит снимать голос и очищать таблицу (через `guideResetKey`).
- [x] **Шаг 3:** Проверить `handleReset` (модераторский): он должен вызывать `setOptimisticVote(null)` и инкрементировать `guideResetKey` для всех. (Уже есть, но нужно убедиться в стабильности).

### Phase 3: Устранение "залипаний"
- [x] **Шаг 1:** Обновить `useEffect` поллинга. Если сервер прислал `vote: null` (новый раунд), а у нас еще висит `optimisticVote`, вызвать `setOptimisticVote(null)` и очистить таблицу.

## Критические моменты
- **Циклические вызовы:** `handleVote` не должен инкрементировать `guideResetKey`, если вызов пришел из самой таблицы (параметр `fromManualClick`).
- **Race conditions:** Обновление `optimisticVote` должно происходить мгновенно до сетевого запроса.

## Testing checklist (Ready for manual testing)
- [ ] UC2: Выбор в таблице -> Карта сверху выбралась.
- [ ] UC1: Клик на карту -> Таблица очистилась.
- [ ] UC4: Снятие всех галок в таблице -> Карта сверху погасла.
- [ ] UC6: Повторный клик на карту -> Карта погасла, таблица очистилась.
- [ ] UC5: Переключение AI под нагрузкой -> Карта меняется мгновенно.
- [ ] UC7: Нажатие "Delete estimates" модератором -> Всё чисто у всех.
- [ ] UC3: Изменение выбора в таблице -> Подсветка карт переключается.

