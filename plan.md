# Implementation Plan v1.6 — 2026-01-30

## Общая стратегия
Исправить баг "самопроизвольного отжатия" ячеек в таблице. Проблема вызвана race condition в Optimistic UI: поллинг сбрасывает `optimisticVote` в `null`, если сервер еще не успел обновить голос, что ошибочно воспринимается как начало нового раунда и очищает таблицу.

## Пошаговый чек-лист

### Phase 4: Bug Fix (Table Selection Race Condition)
- [ ] **Шаг 1:** В `app/room/[id]/page.tsx` уточнить логику очистки `optimisticVote`.
    - Убрать `|| serverVote === null` из условия очистки в `fetchRoom`. Теперь очищаем только если `serverVote === optimisticVote`.
- [ ] **Шаг 2:** Внедрить явный детектор сброса раунда.
    - Использовать `useRef` для отслеживания `room.revealed`.
    - Если `room.revealed` сменился с `true` на `false`, это сигнал о сбросе.
    - В этом случае принудительно вызывать `setOptimisticVote(null)` и `setGuideResetKey(prev => prev + 1)`.
- [ ] **Шаг 3:** Проверить синхронизацию `previousVoteRef` с `currentVote`, чтобы избежать ложных срабатываний `setGuideResetKey`.

## Критические моменты
- **Reset Detection:** Нужно гарантировать, что при нажатии модератором кнопки "Delete estimates", у всех участников (включая модератора) корректно очистится `VotingGuide`.
- **Optimistic UI:** Голос должен "залипать" в UI до тех пор, пока сервер его не подтвердит (не станет `serverVote === optimisticVote`).

## Testing checklist
- [ ] Кликнуть в таблицу Guide -> ячейка остается выбранной, Suggested SP отображается.
- [ ] Дождаться цикла поллинга (3 сек) -> выбор в таблице не исчезает.
- [ ] Нажать "Reveal estimates" -> баллы открылись.
- [ ] Нажать "Delete estimates" -> у всех участников таблица очистилась.
- [ ] Кликнуть по карте "5 SP" -> выделение в таблице исчезло.
