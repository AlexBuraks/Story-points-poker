# PRD: Автоматическая синхронизация Guide Score с дефолтным Estimate

## Обзор задачи
На данный момент `VotingGuide` — это просто визуальная подсказка. Пользователь кликает по таблице, получает "Your score", но затем ему нужно вручную нажать на соответствующую карточку в основном блоке "Your estimate".
**Цель:** Сделать так, чтобы выбор в таблице автоматически проставлял голос (Story Points) в основной функционал голосования.

## Бизнес-цель
Ускорить процесс оценки. Меньше кликов — больше профита. Команда быстрее договаривается, модератор быстрее видит результат.

## Список фич
1.  **Синхронизация:** При изменении "Your score" в `VotingGuide`, автоматически вызывается функция `onVote`, если результат валиден. ✅
2.  **Сброс при ручном выборе:** Если пользователь кликает на любую карточку в "Your estimate", все выделения в таблице `VotingGuide` сбрасываются.
3.  **Сброс при новом раунде:** Когда модератор нажимает "Delete estimates", у всех участников сбрасываются не только голоса и выделения в таблице, но и `optimisticVote` в UI.
4.  **Синхронизация Optimistic UI при сбросе:** Поллинг должен очищать `optimisticVote`, если сервер вернул `null` (означает начало нового раунда).
5.  **Снятие голоса (null):** При полной очистке таблицы или повторном клике на карту, голос на сервере должен становиться `null`.

## Сценарии взаимодействия (Use Cases)

### 1. Прямой выбор (Manual Selection)
*   **Действие:** Юзер кликает на карту "5 SP" в блоке "Your estimate".
*   **Результат:** Карта подсвечивается, голос уходит на сервер, **таблица Guide очищается**.

### 2. Выбор через таблицу (Guide Selection)
*   **Действие:** Юзер выбирает ячейку в таблице (например, Effort: "Half a day").
*   **Результат:** Ячейка подсвечивается, вычисляется Suggested SP ("2 SP"), **карта "2 SP" подсвечивается автоматически**, голос уходит на сервер.

### 3. Изменение выбора в таблице
*   **Действие:** Юзер выбирает другой уровень сложности в таблице.
*   **Результат:** Выделение обновляется, Suggested SP меняется (например, на "5 SP"), **подсветка карт перепрыгивает на "5 SP"**, голос обновляется.

### 4. Сброс через таблицу (Deselection)
*   **Действие:** Юзер снимает все выделения в таблице.
*   **Результат:** Таблица пустая, **подсветка карт сверху снимается**, **голос на сервере сбрасывается (null)**.

### 5. Режим AI (AI Mode)
*   **Действие:** Переключение тумблера AI при уже выбранных ячейках.
*   **Результат:** Значения SP в таблице меняются, **подсветка карт сверху мгновенно переключается на пересчитанный балл**, голос обновляется.

### 6. Отмена голоса вручную
*   **Действие:** Повторный клик на выбранную карту.
*   **Результат:** Подсветка с карты снимается, голос становится `null`, **таблица Guide очищается**.

### 7. Сброс раунда
*   **Действие:** Нажатие "Delete estimates" (модератор).
*   **Результат:** У всех сбрасываются голоса и подсветка карт, **таблицы Guide у всех очищаются**.

## Метрики успеха
- Пользователь кликает в таблицу -> карточка сверху выбирается автоматически.
- Пользователь кликает на карточку сверху -> выделение в таблице исчезает, карточка подсвечивается.
- Нажат сброс голосов ("Delete estimates") -> карточка "Your estimate" очищается у всех участников немедленно.
- После сброса и начала нового раунда, `optimisticVote` не "залипает" от предыдущего раунда.

## Текущий статус
**Реализовано (v1.1 — 2026-01-30):**
- ✅ Полная двусторонняя синхронизация VotingGuide ↔ PokerCard
- ✅ Поддержка сброса голоса через `null` (очистка таблицы, повторный клик на карту)
- ✅ AI Mode toggle с мгновенным пересчетом и автоголосованием
- ✅ Корректная обработка всех 7 сценариев (Use Cases)
- ✅ Защита от "залипания" optimisticVote при поллинге

**Технические детали:**
- VotingGuide (components/voting-guide.tsx:106-112): `useEffect` отправляет `onVote(null)` при очистке таблицы
- Room Page (app/room/[id]/page.tsx:145): `handleVote` принимает `VoteValue | null`
- Room Page (app/room/[id]/page.tsx:339-370): Повторный клик на карту вызывает `handleVote(null, true)` (toggle)
- Room Page (app/room/[id]/page.tsx:72-73): Поллинг очищает `optimisticVote` при `serverVote === null`


