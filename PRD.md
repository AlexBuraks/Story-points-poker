# PRD: Автоматическая синхронизация Guide Score с дефолтным Estimate

## Обзор задачи
На данный момент `VotingGuide` — это просто визуальная подсказка. Пользователь кликает по таблице, получает "Your score", но затем ему нужно вручную нажать на соответствующую карточку в основном блоке "Your estimate".
**Цель:** Сделать так, чтобы выбор в таблице автоматически проставлял голос (Story Points) в основной функционал голосования.

## Бизнес-цель
Ускорить процесс оценки. Меньше кликов — больше профита. Команда быстрее договаривается, модератор быстрее видит результат.

## Список фич
1.  **Синхронизация:** При изменении "Your score" в `VotingGuide`, автоматически вызывается функция `onVote`, если результат валиден. ✅
2.  **Сброс при ручном выборе:** Если пользователь кликает на любую карточку в "Your estimate", все выделения в таблице `VotingGuide` сбрасываются.
3.  **Сброс при новом раунде:** Когда модератор нажимает "Delete estimates", у всех участников сбрасываются не только голоса и выделения в таблице, но и `optimisticVote` в UI.
4.  **Синхронизация Optimistic UI при сбросе:** Поллинг должен очищать `optimisticVote`, если сервер вернул `null` (означает начало нового раунда).
5.  **Снятие голоса (null):** При полной очистке таблицы или повторном клике на карту, голос на сервере должен становиться `null`.

## Сценарии взаимодействия (Use Cases)

### 1. Прямой выбор (Manual Selection)
*   **Действие:** Юзер кликает на карту "5 SP" в блоке "Your estimate".
*   **Результат:** Карта подсвечивается, голос уходит на сервер, **таблица Guide очищается**.

### 2. Выбор через таблицу (Guide Selection)
*   **Действие:** Юзер выбирает ячейку в таблице (например, Effort: "Half a day").
*   **Результат:** Ячейка подсвечивается, вычисляется Suggested SP ("2 SP"), **карта "2 SP" подсвечивается автоматически**, голос уходит на сервер.

### 3. Изменение выбора в таблице
*   **Действие:** Юзер выбирает другой уровень сложности в таблице.
*   **Результат:** Выделение обновляется, Suggested SP меняется (например, на "5 SP"), **подсветка карт перепрыгивает на "5 SP"**, голос обновляется.

### 4. Сброс через таблицу (Deselection)
*   **Действие:** Юзер снимает все выделения в таблице.
*   **Результат:** Таблица пустая, **подсветка карт сверху снимается**, **голос на сервере сбрасывается (null)**.

### 5. Режим AI (AI Mode)
*   **Действие:** Переключение тумблера AI при уже выбранных ячейках.
*   **Результат:** Значения SP в таблице меняются, **подсветка карт сверху мгновенно переключается на пересчитанный балл**, голос обновляется.

### 6. Отмена голоса вручную
*   **Действие:** Повторный клик на выбранную карту.
*   **Результат:** Подсветка с карты снимается, голос становится `null`, **таблица Guide очищается**.

### 7. Сброс раунда
*   **Действие:** Нажатие "Delete estimates" (модератор).
*   **Результат:** У всех сбрасываются голоса и подсветка карт, **таблицы Guide у всех очищаются**.

## Метрики успеха
- Пользователь кликает в таблицу -> карточка сверху выбирается автоматически.
- Пользователь кликает на карточку сверху -> выделение в таблице исчезает, карточка подсвечивается.
- Нажат сброс голосов ("Delete estimates") -> карточка "Your estimate" очищается у всех участников немедленно.
- После сброса и начала нового раунда, `optimisticVote` не "залипает" от предыдущего раунда.

## Текущий статус
**Реализовано (v1.1 — 2026-01-30):**
- ✅ Полная двусторонняя синхронизация VotingGuide ↔ PokerCard
- ✅ Поддержка сброса голоса через `null` (очистка таблицы, повторный клик на карту)
- ✅ AI Mode toggle с мгновенным пересчетом и автоголосованием
- ✅ Корректная обработка всех 7 сценариев (Use Cases)
- ✅ Защита от "залипания" optimisticVote при поллинге

## Оптимизация производительности (Lag Reduction)
**Проблема:** При нажатии "Show/Hide estimates" или "Delete estimates" модератор видит задержку, так как UI ждет ответа от API и следующего цикла поллинга.
**Цель:** Внедрить Optimistic UI для всех действий модератора.

1.  **Show/Hide Toggle:** Состояние `room.revealed` должно меняться мгновенно в локальном стейте, не дожидаясь ответа сервера.
2.  **Delete Estimates:** Состояние комнаты должно мгновенно сбрасываться локально (все голоса в `null`, `revealed: false`).
3.  **Loading States:** Минимизировать использование блокирующих лоадеров (`isLoading`), которые делают UI "тяжелым".

**Технические детали:**
- VotingGuide (components/voting-guide.tsx:106-112): `useEffect` отправляет `onVote(null)` при очистке таблицы
- Room Page (app/room/[id]/page.tsx:145): `handleVote` принимает `VoteValue | null`
- Room Page (app/room/[id]/page.tsx:339-370): Повторный клик на карту вызывает `handleVote(null, true)` (toggle)
- Room Page (app/room/[id]/page.tsx:72-73): Поллинг очищает `optimisticVote` при `serverVote === null`

## Open Source Release (v1.2) - 2026-01-30

### Цели
1.  **Публичность:** Сделать репозиторий доступным для всех (Public).
2.  **Безопасность:** Гарантировать отсутствие секретов в коде.
3.  **Документация:** Подготовить README и LICENSE для внешних пользователей.

### Требования
- Аудит на наличие hardcoded токенов или путей.
- Наличие MIT License.
- Инструкция по установке в README.

## Draft vs Final Estimates (v1.3)

### Проблема
Когда пользователь выбирает критерии в `VotingGuide`, у него сразу проставляется голос на сервере и другие участники видят зеленую галочку. Это вводит в заблуждение: кажется, что человек уже закончил, хотя он еще только прикидывает сложность в таблице.

### Бизнес-цель
Сделать процесс голосования прозрачным. Разграничить "я еще думаю/считаю" и "я сделал окончательный выбор".

### Новые фичи
1.  **Статус "Thinking" (⏳):**
    - Если пользователь взаимодействует с таблицей `VotingGuide`, его статус на сервере обновляется на `thinking`.
    - Другие участники видят иконку "⏳" вместо зеленой галочки.
2.  **Статус "Voted" (✅):**
    - Прямой клик по карточке в "Your Estimate" считается окончательным выбором.
    - Добавляется кнопка "Confirm" в блоке `VotingGuide` (рядом с Suggested SP), которая переводит "черновой" голос в "окончательный".
3.  **Авто-переход:** Если пользователь уже выбрал в таблице и потом кликнул на подсвеченную карточку — голос становится финальным.

### Метрики успеха
- В таблице критериев -> у других юзеров иконка "⏳".
- Нажал на карту или "Confirm" -> у других юзеров иконка "✅".
- "Show estimates" нажимается только тогда, когда у всех "✅".
### Phase 4: Bug Fix (Race Condition in Table Selection)
**Цель:** Устранить баг "самопроизвольного отжатия" ячеек в таблице.
**Решение:**
- Корректировка логики Optimistic UI: `optimisticVote` не должен сбрасываться поллингом, если сервер вернул `null`, но запрос на голосование еще в пути или не обработан.
- Явное детектирование сброса раунда (Reset) через отслеживание изменения статуса `revealed` (true -> false).

## Метрики успеха
- Выбор в таблице стабилен и не "прыгает" при поллинге.
- При сбросе модератором таблица очищается у всех.
- При ручном выборе карты таблица очищается корректно.
